---
layout: post
title: openstack neutron网络实验
key: 20160208
tags:  openstack neutron
modify_date: 2018-04-11
---

在openstack中创建实例的时候必须选择一个网络，因此我们先以租户的角色创建一个网络用于测试。

## 3. Neutron网络介绍

安装完毕之后，宿主机通过网口eth0使用NAT访问外部网络，ip是virtualbox自动分配的10.0.2.15/24，而网口eth1用作openstack实例间通信，ip是我们在Vagrant中指定的。
openstack中的虚机通过网桥br-ex访问外部网络，因此我们需要将网络节点的eth0加入到br-ex网桥中。加入网桥后，必须将其ip配到br-ex上，否则外部无法访问（体现在：1. vagrant ssh无法登陆宿主机；2. floating ip无法访问openstack实例，因为网络节点没有floating ip的路由)


网络拓扑查看命令：
1. ovs-vsctl show, 查看ovs网桥
2. brctl show，查看linux网桥
3. ip netns，查看网络命名空间
4. ip address，查看root命名空间内的设备
4. ip netns exec \<namespace\> ip address，查看指定命名空间内的设备

### 3.1 从零开始
openstack初始安装完成后，在网络节点上运行上述命令：
``` bash
$ sudo ovs-vsctl show 
ef2ce1ab-4571-4e55-84b8-50163f9c0e0a
    Manager "ptcp:6640:127.0.0.1"
        is_connected: true
    Bridge br-tun
        Controller "tcp:127.0.0.1:6633"
            is_connected: true
        fail_mode: secure
        Port br-tun
            Interface br-tun
                type: internal
        Port patch-int
            Interface patch-int
                type: patch
                options: {peer=patch-tun}
    Bridge br-ex
        Controller "tcp:127.0.0.1:6633"
            is_connected: true
        fail_mode: secure
        Port phy-br-ex
            Interface phy-br-ex
                type: patch
                options: {peer=int-br-ex}
        Port br-ex
            Interface br-ex
                type: internal
    Bridge br-int
        Controller "tcp:127.0.0.1:6633"
            is_connected: true
        fail_mode: secure
        Port int-br-ex
            Interface int-br-ex
                type: patch
                options: {peer=phy-br-ex}
        Port patch-tun
            Interface patch-tun
                type: patch
                options: {peer=patch-int}
        Port br-int
            Interface br-int
                type: internal
    ovs_version: "2.9.0"
$ brctl show
bridge name     bridge id               STP enabled     interfaces
$ ip netns
$ ip address | grep ^[0-9] 
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN qlen 1
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000
3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000
4: ovs-system: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN qlen 1000
5: br-ex: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN qlen 1000
6: br-int: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN qlen 1000
7: br-tun: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN qlen 1000
```
上述结果显示，openstack默认在网络节点上创建了3个ovs网桥，分别为br-tun，br-ex，br-int，其中br-int分布和br-tun，br-ex互联，拓扑图如下：

![neutron-0.jpg](http://o7gg8x7fi.bkt.clouddn.com/neutron-0.jpg)

### 3.2 创建租户私有网络
在openstack dashborad上创建一个租户网络，菜单路径为Project -> Network -> Networks -> Create Network。


创建完毕后，网络节点拓扑变化如下：
```  bash
$ sudo ovs-vsctl show
...
    Bridge br-int
        Controller "tcp:127.0.0.1:6633"
            is_connected: true
        fail_mode: secure
        Port int-br-ex
            Interface int-br-ex
                type: patch
                options: {peer=phy-br-ex}
        Port patch-tun
            Interface patch-tun
                type: patch
                options: {peer=patch-int}
        Port br-int
            Interface br-int
                type: internal
        Port "tape68eed07-f5"
            tag: 2
            Interface "tape68eed07-f5"
                type: internal
...
$ ip netns
qdhcp-d18f42ff-a688-4c57-acde-6299326022dc
[vagrant@os-ctl1 ~]$ sudo ip netns exec qdhcp-d18f42ff-a688-4c57-acde-6299326022dc ip address | grep ^[0-9] 
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN qlen 1
9: tape68eed07-f5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UNKNOWN qlen 1000
```
上述结果表示，neutron为dhcp服务创建了一个命名空间，并创建了一个TAP设备tape68eed07-f5作为dhcp的网口，该网口被加入到br-int网桥中，拓扑图如下：
![neutron-1.jpg](http://o7gg8x7fi.bkt.clouddn.com/neutron-1.jpg)

### 3.3 启动实例并将其接入网络
在openstack dashborad上创建一个虚机实例，菜单路径为Project -> Compute -> Instances -> Launch Instance。
实例启动成功后，在网络节点上运行上述命令：
``` bash
$ sudo ovs-vsctl show 
...
    Bridge br-int
        Controller "tcp:127.0.0.1:6633"
            is_connected: true
        fail_mode: secure
        Port "qvo5d07f509-f1"
            tag: 2
            Interface "qvo5d07f509-f1"
        Port int-br-ex
            Interface int-br-ex
                type: patch
                options: {peer=phy-br-ex}
        Port patch-tun
            Interface patch-tun
                type: patch
                options: {peer=patch-int}
        Port br-int
            Interface br-int
                type: internal
        Port "tape68eed07-f5"
            tag: 2
            Interface "tape68eed07-f5"
                type: internal
...
$ brctl show
bridge name     bridge id               STP enabled     interfaces
qbr5d07f509-f1          8000.2eeb31a8ff84       no              qvb5d07f509-f1
                                                        tap5d07f509-f1
$ ip address | grep ^[0-9] 
...
10: qbr5d07f509-f1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UP qlen 1000
11: qvo5d07f509-f1@qvb5d07f509-f1: <BROADCAST,MULTICAST,PROMISC,UP,LOWER_UP> mtu 1450 qdisc noqueue master ovs-system state UP qlen 1000
12: qvb5d07f509-f1@qvo5d07f509-f1: <BROADCAST,MULTICAST,PROMISC,UP,LOWER_UP> mtu 1450 qdisc noqueue master qbr5d07f509-f1 state UP qlen 1000
13: tap5d07f509-f1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc pfifo_fast master qbr5d07f509-f1 state UNKNOWN qlen 1000                                                        
```
上述结果表示，neutron为新实例创建了一个Linux网桥qbr5d07f509-f1，该网桥包含两个接口：
1. qvb5d07f509-f1，这个设备和qvo5d07f509-f1是一对VETH设备，而qvo5d07f509-f1被加入到了OVS网桥br-int中。
2. tap5d07f509-f1，这个TAP设备就是供新实例接入网络的接口

拓扑图如下：
![neutron-2.jpg](http://o7gg8x7fi.bkt.clouddn.com/neutron-2.jpg)

然后进到创建的实例中查看网络信息：
``` bash
$ sudo virsh list
 Id    Name                           State
----------------------------------------------------
 1     instance-00000001              running

[vagrant@os-ctl1 ~]$ sudo virsh console 1
Connected to domain instance-00000001
Escape character is ^]

login as 'cirros' user. default password: 'cubswin:)'. use 'sudo' for root.
cirros login: cirros
Password: 
$ ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 16436 qdisc noqueue 
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc pfifo_fast qlen 1000
    link/ether fa:16:3e:85:a9:84 brd ff:ff:ff:ff:ff:ff
    inet 172.16.2.7/24 brd 172.16.2.255 scope global eth0
    inet6 fe80::f816:3eff:fe85:a984/64 scope link 
       valid_lft forever preferred_lft forever
$ ping 172.16.2.2
PING 172.16.2.2 (172.16.2.2): 56 data bytes
64 bytes from 172.16.2.2: seq=0 ttl=64 time=3.599 ms

--- 172.16.2.2 ping statistics ---
1 packets transmitted, 1 packets received, 0% packet loss
round-trip min/avg/max = 3.599/3.599/3.599 ms
$ ping 172.16.2.1
PING 172.16.2.1 (172.16.2.1): 56 data bytes

--- 172.16.2.1 ping statistics ---
2 packets transmitted, 0 packets received, 100% packet loss
```
可以看到，dhcp为该实例分配了地址172.16.2.7，并且可以ping通dhcp服务器172.16.2.2，但是无法ping通网关172.16.2.1，这是因为目前的实验仅仅局限在子网内部，我们还没有创建网关提供路由服务。



